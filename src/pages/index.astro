---
/*
  ── ISS URINE PROCESSING ASSEMBLY (UPA) TELEMETRY DASHBOARD ──
  Now powered by Astro Islands — each interactive section is an independently
  hydrated Preact component.  Static HTML ships as zero-JS; islands hydrate
  with different strategies (client:load, client:idle, client:visible).
  Shared state across islands is managed by nanostores.
*/
import HeaderBar      from '../components/HeaderBar';
import TelemetryPanel from '../components/TelemetryPanel';
import EventLog       from '../components/EventLog';
import StatsPanel     from '../components/StatsPanel';
import IssMap         from '../components/IssMap';
import CrewPanel      from '../components/CrewPanel';
import NewsPanel      from '../components/NewsPanel';
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>MCC‑H · UPA Telemetry</title>

    <!-- Google Font – clean sans + monospace for readability -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet" />

    <!-- Leaflet — open-source map library for ISS ground track -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" is:inline></script>

    <style is:global>
      /* ───────── RESET & BASE ───────── */
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

      /* ───────── ASTRO ISLAND WRAPPERS ─────────
         Each client: island gets a <astro-island> wrapper.
         Make them transparent to grid/flex layouts. */
      astro-island {
        display: contents;
      }
      /* In grid contexts where we need the island to occupy a cell, use block */
      .panels-row > astro-island,
      .intel-grid > astro-island {
        display: block;
      }
      .intel-sidebar > astro-island {
        display: flex;
        flex: 1;
        flex-direction: column;
      }
      .intel-sidebar > astro-island > .sidebar-panel {
        flex: 1;
      }

      :root {
        --c-bg:        #121926;
        --c-panel:     #1a2332;
        --c-card:      #1e293b;
        --c-border:    #2d3a4d;
        --c-accent:    #6b9fcc;
        --c-accent2:   #7bafd4;
        --c-warn:      #d4a148;
        --c-danger:    #c95555;
        --c-ok:        #5fa87a;
        --c-text:      #c8d1db;
        --c-dim:       #7a8899;
        --font-sans:   'Inter', -apple-system, sans-serif;
        --font-mono:   'JetBrains Mono', 'Consolas', monospace;
      }

      html { font-size: 14.5px; }

      body {
        font-family: var(--font-sans);
        background: var(--c-bg);
        color: var(--c-text);
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* ───────── TOP BAR ───────── */
      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: .6rem 1.5rem;
        border-bottom: 1px solid var(--c-border);
        background: #151d2b;
      }

      .topbar-left { display: flex; align-items: center; gap: 1rem; }

      .mission-badge {
        font-family: var(--font-mono);
        font-weight: 700;
        font-size: .95rem;
        letter-spacing: 1.5px;
        color: var(--c-accent);
        text-transform: uppercase;
      }

      .mission-sub {
        font-size: .7rem;
        color: var(--c-dim);
        letter-spacing: .3px;
      }

      .topbar-right {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        font-size: .75rem;
        font-family: var(--font-mono);
        color: var(--c-dim);
      }

      .status-dot {
        display: inline-block;
        width: 7px; height: 7px;
        border-radius: 50%;
        background: var(--c-ok);
        margin-right: .3rem;
        animation: pulse-dot 2.5s ease-in-out infinite;
      }
      .status-dot.warn { background: var(--c-warn); }
      .status-dot.danger { background: var(--c-danger); animation-duration: .8s; }

      @keyframes pulse-dot {
        0%, 100% { opacity: 1; }
        50% { opacity: .35; }
      }

      #utc-clock { color: var(--c-accent2); }

      /* ───────── SECONDARY NAV BAR ───────── */
      .subbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: .3rem 1.5rem;
        background: #141b28;
        border-bottom: 1px solid rgba(45, 58, 77, .6);
        font-size: .65rem;
        font-family: var(--font-mono);
        color: var(--c-dim);
        letter-spacing: .3px;
      }

      .subbar span { display: flex; align-items: center; gap: .4rem; }

      /* ───────── MAIN LAYOUT ───────── */
      .dashboard {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
        padding: 1rem 1.5rem 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* ── Section titles ── */
      .section-title {
        font-family: var(--font-mono);
        font-size: .65rem;
        font-weight: 600;
        letter-spacing: 2px;
        color: var(--c-dim);
        text-transform: uppercase;
        padding-bottom: .45rem;
        border-bottom: 1px solid var(--c-border);
        margin-bottom: .65rem;
      }

      /* ───────── THE ISLAND — central panel ───────── */
      .island {
        position: relative;
        background: var(--c-panel);
        border: 1px solid var(--c-border);
        border-radius: 8px;
        padding: 1.5rem 2rem 2rem;
      }

      .island-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.5rem;
      }

      .island-title {
        font-family: var(--font-mono);
        font-size: .8rem;
        font-weight: 700;
        letter-spacing: 1.5px;
        color: var(--c-accent);
      }

      .island-subtitle {
        font-size: .65rem;
        color: var(--c-dim);
        margin-top: .2rem;
      }

      .island-badge {
        padding: .2rem .7rem;
        border-radius: 4px;
        font-family: var(--font-mono);
        font-size: .6rem;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        border: 1px solid var(--c-border);
        color: var(--c-dim);
      }
      .island-badge.nominal { border-color: var(--c-ok); color: var(--c-ok); background: rgba(95,168,122,.08); }
      .island-badge.caution { border-color: var(--c-warn); color: var(--c-warn); background: rgba(212,161,72,.08); }
      .island-badge.alert   { border-color: var(--c-danger); color: var(--c-danger); background: rgba(201,85,85,.08); }

      /* ── Tank Cards Grid ── */
      .tank-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1rem;
      }

      .tank-card {
        position: relative;
        background: var(--c-card);
        border: 1px solid var(--c-border);
        border-radius: 6px;
        padding: 1.1rem 1.1rem .9rem;
        transition: border-color .3s;
      }
      .tank-card:hover {
        border-color: var(--c-accent);
      }

      .tank-label {
        font-family: var(--font-mono);
        font-size: .65rem;
        font-weight: 700;
        letter-spacing: 1.5px;
        color: var(--c-accent2);
        margin-bottom: .1rem;
      }

      .tank-fullname {
        font-size: .6rem;
        color: var(--c-dim);
        margin-bottom: .75rem;
      }

      .tank-ls-id {
        font-family: var(--font-mono);
        font-size: .52rem;
        color: rgba(122,136,153,.5);
        margin-bottom: .4rem;
        letter-spacing: .5px;
      }

      /* ── Gauge Bar ── */
      .gauge-track {
        position: relative;
        height: 8px;
        background: rgba(45, 58, 77, .6);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: .55rem;
      }

      .gauge-fill {
        height: 100%;
        border-radius: 4px;
        transition: width .8s cubic-bezier(.22,1,.36,1), background .5s;
        background: var(--c-accent);
        width: 0%;
      }

      .gauge-fill.warn  { background: var(--c-warn); }
      .gauge-fill.danger { background: var(--c-danger); animation: bar-pulse 1s ease-in-out infinite alternate; }

      @keyframes bar-pulse {
        from { opacity: 1; }
        to   { opacity: .6; }
      }

      .tank-readout {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
      }

      .tank-value {
        font-family: var(--font-mono);
        font-size: 1.5rem;
        font-weight: 700;
        color: #e2e8f0;
        line-height: 1;
      }
      .tank-value .unit {
        font-size: .7rem;
        color: var(--c-dim);
        margin-left: .1rem;
      }

      .tank-status {
        font-family: var(--font-mono);
        font-size: .55rem;
        font-weight: 600;
        letter-spacing: 1px;
        text-transform: uppercase;
        padding: .15rem .5rem;
        border-radius: 3px;
        background: rgba(95,168,122,.1);
        color: var(--c-ok);
      }
      .tank-status.warn   { background: rgba(212,161,72,.1); color: var(--c-warn); }
      .tank-status.danger { background: rgba(201,85,85,.1);  color: var(--c-danger); }

      /* ── Timestamp row ── */
      .tank-ts {
        margin-top: .4rem;
        font-family: var(--font-mono);
        font-size: .52rem;
        color: var(--c-dim);
        text-align: right;
      }

      /* ───────── BOTTOM PANELS ROW ───────── */
      .panels-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .panel {
        background: var(--c-panel);
        border: 1px solid var(--c-border);
        border-radius: 6px;
        padding: 1.1rem;
      }

      /* ── Event Log ── */
      .log-list {
        list-style: none;
        max-height: 180px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--c-border) transparent;
      }

      .log-list li {
        display: flex;
        align-items: flex-start;
        gap: .5rem;
        padding: .35rem 0;
        border-bottom: 1px solid rgba(45, 58, 77, .4);
        font-size: .68rem;
        color: var(--c-dim);
      }

      .log-time {
        font-family: var(--font-mono);
        color: var(--c-accent2);
        white-space: nowrap;
        min-width: 5.2rem;
        font-size: .62rem;
      }
      .log-tag {
        font-family: var(--font-mono);
        padding: .05rem .35rem;
        border-radius: 2px;
        font-size: .52rem;
        font-weight: 600;
        letter-spacing: .5px;
        text-transform: uppercase;
        white-space: nowrap;
      }
      .log-tag.info    { background: rgba(107,159,204,.1);  color: var(--c-accent); }
      .log-tag.warning { background: rgba(212,161,72,.1);   color: var(--c-warn); }
      .log-tag.alert   { background: rgba(201,85,85,.1);    color: var(--c-danger); }

      /* ── Stats Sidebar ── */
      .stat-row {
        display: flex;
        justify-content: space-between;
        padding: .45rem 0;
        border-bottom: 1px solid rgba(45, 58, 77, .4);
        font-size: .72rem;
      }
      .stat-row:last-child { border-bottom: none; }
      .stat-label { color: var(--c-dim); }
      .stat-value { font-family: var(--font-mono); color: #e2e8f0; font-weight: 500; }

      /* ───────── MISSION INTELLIGENCE SECTION ───────── */
      .intel-section {
        background: var(--c-panel);
        border: 1px solid var(--c-border);
        border-radius: 8px;
        padding: 1.5rem 2rem 2rem;
      }

      .intel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
      }

      .intel-title {
        font-family: var(--font-mono);
        font-size: .8rem;
        font-weight: 700;
        letter-spacing: 1.5px;
        color: var(--c-accent);
      }

      .intel-subtitle {
        font-size: .65rem;
        color: var(--c-dim);
        margin-top: .2rem;
      }

      .tech-badges { display: flex; gap: .4rem; }

      .tech-badge {
        padding: .15rem .55rem;
        border-radius: 3px;
        font-family: var(--font-mono);
        font-size: .5rem;
        font-weight: 600;
        letter-spacing: .8px;
        text-transform: uppercase;
        border: 1px solid var(--c-border);
        color: var(--c-dim);
      }
      .tech-badge.curl    { border-color: #c084fc; color: #c084fc; background: rgba(192,132,252,.06); }
      .tech-badge.guzzle  { border-color: #fb923c; color: #fb923c; background: rgba(251,146,60,.06); }
      .tech-badge.crawler { border-color: #34d399; color: #34d399; background: rgba(52,211,153,.06); }

      .intel-grid {
        display: grid;
        grid-template-columns: 1.4fr 1fr;
        gap: 1rem;
      }

      /* ── Map Panel ── */
      .map-panel {
        background: var(--c-card);
        border: 1px solid var(--c-border);
        border-radius: 6px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: .65rem 1rem;
        border-bottom: 1px solid var(--c-border);
      }

      .panel-title {
        font-family: var(--font-mono);
        font-size: .6rem;
        font-weight: 700;
        letter-spacing: 1.5px;
        color: var(--c-accent2);
      }

      .panel-meta {
        font-family: var(--font-mono);
        font-size: .48rem;
        color: rgba(122,136,153,.6);
        letter-spacing: .3px;
      }

      #iss-map {
        width: 100%;
        height: 320px;
        background: #0d1117;
      }

      .map-readouts {
        display: flex;
        gap: 1.5rem;
        padding: .6rem 1rem;
        border-top: 1px solid var(--c-border);
        font-size: .68rem;
        color: var(--c-dim);
      }

      .map-readouts span { display: flex; align-items: center; gap: .3rem; }
      .map-readouts strong {
        font-family: var(--font-mono);
        color: #e2e8f0;
        font-weight: 500;
      }

      /* ── Sidebar — crew + news ── */
      .intel-sidebar { display: flex; flex-direction: column; gap: 1rem; }

      .sidebar-panel {
        background: var(--c-card);
        border: 1px solid var(--c-border);
        border-radius: 6px;
        overflow: hidden;
        flex: 1;
      }

      /* Crew */
      .crew-summary {
        padding: .5rem 1rem 0;
        font-size: .72rem;
        color: var(--c-dim);
      }
      .crew-summary strong {
        font-family: var(--font-mono);
        color: #e2e8f0;
      }
      .crew-total { font-size: .6rem; color: var(--c-dim); }

      .crew-list {
        list-style: none;
        padding: .4rem 1rem .6rem;
        max-height: 160px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--c-border) transparent;
      }

      .crew-list li {
        display: flex;
        align-items: center;
        gap: .5rem;
        padding: .3rem 0;
        border-bottom: 1px solid rgba(45, 58, 77, .3);
        font-size: .68rem;
      }
      .crew-list li:last-child { border-bottom: none; }

      .crew-dot {
        width: 5px; height: 5px;
        border-radius: 50%;
        background: var(--c-ok);
        flex-shrink: 0;
      }

      .crew-name { color: #e2e8f0; }
      .crew-craft { font-family: var(--font-mono); font-size: .52rem; color: var(--c-dim); }

      .crew-list .placeholder,
      .news-list .placeholder {
        color: var(--c-dim);
        font-size: .65rem;
        padding: .5rem 0;
      }

      /* News */
      .news-list {
        list-style: none;
        padding: .4rem 1rem .6rem;
        max-height: 190px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--c-border) transparent;
      }

      .news-list li {
        padding: .45rem 0;
        border-bottom: 1px solid rgba(45, 58, 77, .3);
      }
      .news-list li:last-child { border-bottom: none; }

      .news-title {
        font-size: .68rem;
        color: var(--c-accent2);
        text-decoration: none;
        line-height: 1.35;
        display: block;
      }
      .news-title:hover { color: var(--c-accent); text-decoration: underline; }

      .news-date {
        font-family: var(--font-mono);
        font-size: .48rem;
        color: var(--c-dim);
        margin-top: .15rem;
      }

      .news-excerpt {
        font-size: .6rem;
        color: rgba(200,209,219,.5);
        margin-top: .15rem;
        line-height: 1.3;
      }

      /* ───────── RESPONSIVE ───────── */
      @media (max-width: 768px) {
        .topbar { flex-direction: column; gap: .5rem; text-align: center; }
        .topbar-right { justify-content: center; flex-wrap: wrap; }
        .panels-row { grid-template-columns: 1fr; }
        .island { padding: 1.25rem 1rem; }
        .tank-grid { grid-template-columns: 1fr; }
        .intel-grid { grid-template-columns: 1fr; }
        .intel-section { padding: 1.25rem 1rem; }
        #iss-map { height: 240px; }
        .map-readouts { flex-wrap: wrap; gap: .75rem; }
        .intel-header { flex-direction: column; gap: .5rem; align-items: flex-start; }
      }
    </style>
  </head>

  <body>
    <!-- ═══════ Island: HeaderBar (clock, connection, signal) — hydrates immediately ═══════ -->
    <HeaderBar client:load />

    <!-- ═══════ DASHBOARD ═══════ -->
    <main class="dashboard">

      <!-- Island: TelemetryPanel — hydrates immediately for live Lightstreamer data -->
      <TelemetryPanel client:load />

      <!-- ── BOTTOM PANELS ── -->
      <div class="panels-row">
        <!-- Island: EventLog — hydrates immediately (shows live events from all islands via nanostores) -->
        <EventLog client:load />

        <!-- Island: StatsPanel — hydrates immediately -->
        <StatsPanel client:load />
      </div>

      <!-- ═══════ MISSION INTELLIGENCE — map / crew / news ═══════ -->
      <section class="intel-section">
        <div class="intel-header">
          <div>
            <div class="intel-title">MISSION INTELLIGENCE</div>
            <div class="intel-subtitle">ISS ground track, crew manifest &amp; NASA news — powered by PHP cURL, Guzzle &amp; web crawler</div>
          </div>
          <div class="tech-badges">
            <span class="tech-badge curl">cURL</span>
            <span class="tech-badge guzzle">Guzzle</span>
            <span class="tech-badge crawler">Crawler</span>
          </div>
        </div>

        <div class="intel-grid">
          <!-- Island: IssMap — hydrates only when scrolled into view (client:visible) -->
          <IssMap client:visible />

          <!-- ── SIDEBAR: crew + news ── -->
          <div class="intel-sidebar">
            <!-- Island: CrewPanel — hydrates when browser is idle (client:idle) -->
            <CrewPanel client:idle />

            <!-- Island: NewsPanel — hydrates when browser is idle (client:idle) -->
            <NewsPanel client:idle />
          </div>
        </div>
      </section>

    </main>
  </body>
</html>
